<!DOCTYPE html>
<html lang="en">

{include file="public:header"}

<body class="bg_normal">

		<div class="back_box">
				旅拍发布
				<a class="back_icon" href="javascript:history.back(-1)">
					<img src="__HOME__/img/icon_right.png" width="6" height="11" alt="">
				</a>		
			</div>

	<!-- 公共顶部 -->
{include file="public:top"}

	<form id="logoForm" action="{:url('Publish/save')}" method="POST" enctype="multipart/form-data" >
		<div class="form_btn am-text-right p_12 bg_normal">
			<button class="am-btn am-btn-danger am-round" type="submit">发布</button>
		</div>
		<div class="bd_btm_10">
			<a href="javascript:;" class="form_group flex_between p_12 bg_white">
				<div class="flex_normal">
					<img class="mar_rt_6" src="__HOME__/img/icon_position.png" width="16" height="16" alt=""><span>添加地点</span>
				</div>
				<div class="flex_normal">
					<input id="myAddrs" type="text" name="addr" class="flex_1 col_nine am-text-sm mar_rt_6 am-text-right" placeholder="选择城市" /><img src="__HOME__/img/icon_right.png" width="6" height="11" alt="">
				</div>
			</a>
		</div>
		<div class="bd_btm_10">
			<a href="javascript:;" class="form_group flex_between p_12 bg_white">
				<div class="flex_normal">
					<img class="mar_rt_6" src="__HOME__/img/icon_time.png" width="16" height="16" alt=""><span>拍摄日期</span>
				</div>
				<div class="flex_normal">
					<input type="text" value="{$dates}" name="dates" class="flex_1 col_nine am-text-sm am-text-right" readonly
						data-am-datepicker="{format: 'yyyy-mm-dd'}" /><img class="mar_lt_6" src="__HOME__/img/icon_right.png"
						width="6" height="11" alt="">
				</div>
			</a>
		</div>
		<div class="bd_btm_10">
			<div class="form_group p_12 bg_white">
				<h5 class="mar_btm_6">故事标题</h5>
				<input class="am-block am-text-sm" type="text" name="title" placeholder="输入标题">
			</div>
		</div>
		<div class="bd_btm_10">
			<div class="form_group p_12 bg_white">
				<h5 class="mar_btm_6">旅行故事</h5>
				<textarea class="form_area am-block am-text-sm" name="content" style="resize:none;width: 100%;height: 120px;" placeholder="分享你的旅行故事，最多500字"></textarea>
			</div>
		</div>

		<!-- 上传图片 -->
		<div class="custom_img p_12">
			<div class="custom_img_top mar_btm_12">
				<h5 class="travel_wei">旅行图片</h5>
				<div><span class="upload_img_length">0</span>/4</div>
			</div>

			<!--点击上传图片 触发下面的div 点击事件-->
			<div class="upload_img_wrap">
				<div id="imgBox"></div>
				<img class="upload_img" data-id="1" src="__HOME__/img/upload_img.png" />
				<img style="display:none" class="upload_img" data-id="2" src="__HOME__/img/upload_img.png" />
				<img style="display:none" class="upload_img" data-id="3" src="__HOME__/img/upload_img.png" />
				<img style="display:none" class="upload_img" data-id="4" src="__HOME__/img/upload_img.png" />
			</div>
			<div style="display: none;width: 100%;height: 100vh;position: relative;">
				<!-- <form id="upBox" class="upload_form" action="" method="post" enctype="multipart/form-data"> -->
					<div style="display: none;" id="inputBox">
						<input type="file" name="image[]" data-id="1" title="请选择图片" id="file1" accept="image/png,image/jpg,image/gif,image/JPEG"  />
						<input type="file" name="image[]" data-id="2" title="请选择图片" id="file2" accept="image/png,image/jpg,image/gif,image/JPEG" />
						<input type="file" name="image[]" data-id="3" title="请选择图片" id="file3" accept="image/png,image/jpg,image/gif,image/JPEG" />
						<input type="file" name="image[]" data-id="4" title="请选择图片" id="file4" accept="image/png,image/jpg,image/gif,image/JPEG" /> 点击选择图片
					</div>
					<input style="display:none" type="submit" id="sub" />
				<!-- </form> -->
			</div>
		</div>

	</form>

	<script>
			$(function () {
				
	
			});
		</script>

	<script type="text/javascript">
	// 选择上传图片
	var imgNum = 0;
	
	$(".upload_img_wrap .upload_img").bind("click", function (ev) {
		//console.log(ev.currentTarget.dataset.id)
		var index = ev.currentTarget.dataset.id;
		var that = this;
	
		if (index == 1) {
			$("#file1").click();
			$("#file1").unbind().change(function (e) {
				var index = e.currentTarget.dataset.id;
				if ($('#file').val() == '') {
					return false;
				}
				$(that).hide();
				var filePath = $(this).val();
				changeImg(e, filePath, index);
               
				imgNum++;
				if (imgNum < 4) {
					$(".upload_img").eq(1).show();
				}
				$(".upload_img_length").html(imgNum);
			})
		} else if (index == 2) {
			$("#file2").click();
			$("#file2").unbind().change(function (e) {
				var index = e.currentTarget.dataset.id;
				if ($('#file').val() == '') {
					return false;
				}
				$(that).hide();
				var filePath = $(this).val();
				changeImg(e, filePath, index);

				imgNum++;
				if (imgNum < 4) {
					$(".upload_img").eq(2).show();
				}
				$(".upload_img_length").html(imgNum);
			})
		} else if (index == 3) {
			$("#file3").click();
			$("#file3").unbind().change(function (e) {
				var index = e.currentTarget.dataset.id;
				if ($('#file').val() == '') {
					return false;
				}
				$(that).hide();
				var filePath = $(this).val();
				changeImg(e, filePath, index);

				imgNum++;
				if (imgNum < 4) {
					$(".upload_img").eq(3).show();
				}
				$(".upload_img_length").html(imgNum);
			})
		} else if (index == 4) {
			$("#file4").click();
			$("#file4").unbind().change(function (e) {
				var index = e.currentTarget.dataset.id;
				if ($('#file').val() == '') {
					return false;
				}
				var filePath = $(this).val();
				changeImg(e, filePath, index);
				$(that).hide();
				imgNum++;
				$(".upload_img_length").html(imgNum);
			})
		}
	})


	


	// 选择上传图片

	function changeImg(e, filePath, index) {
		fileFormat = filePath.substring(filePath.lastIndexOf(".")).toLowerCase();
		//检查后缀名
		if (!fileFormat.match(/.png|.jpg|.jpeg/)) {
			showError('文件格式必须为：png/jpg/jpeg');
			return;
		}
		//获取并记录图片的base64编码
		var reader = new FileReader();
		reader.readAsDataURL(e.target.files[0]);
		reader.onloadend = function () {
			// 图片的 base64 格式, 可以直接当成 img 的 src 属性值        
			var dataURL = reader.result;
			// console.log(dataURL)
			// 显示图片
			$("#imgBox").html($("#imgBox").html() + '<div class="imgContainer" data-index=' + index + '><img src=' +
				dataURL + ' onclick="imgDisplay(this)"><img onclick="removeImg(this,' + index +
				')" class="imgDelete" src="__HOME__/img/del_img.png" /></div>');
		}
	}

	function removeImg(obj, index) {
		for (var i = 0; i < $(".imgContainer").length; i++) {
			if ($(".imgContainer").eq(i).attr("data-index") == index) {
				$(".imgContainer").eq(i).remove();
				
			}
		}
		for (var i = 0; i < $(".upload_img").length; i++) {
			$(".upload_img").eq(i).hide();
			if ($(".upload_img").eq(i).attr("data-id") == index) {
				// console.log($(".upload_img").eq(i).attr("data-id"))
				$(".upload_img").eq(i).show();
			}
		}
		imgNum--;
		
		$(".upload_img_length").html(imgNum);
	}

	function imgDisplay(obj) {
		var src = $(obj).attr("src");
		var imgHtml =
			'<div style="width: 100%;height: 100vh;overflow: auto;background: rgba(0,0,0,0.5);text-align: center;position: fixed;top: 0;left: 0;z-index: 1000;display: flex;justify-content: center;align-items: center;"><img src=' +
			src +
			' style="margin-top: 100px;width: 96%;margin-bottom: 100px;"><p style="font-size: 50px;position: fixed;top: 30px;right: 30px;color: white;cursor: pointer;" onclick="closePicture(this)">×</p></div>'
		$('body').append(imgHtml);
	}

	function closePicture(obj) {
		$(obj).parent("div").remove();
	}

	$('#logoForm').ajaxForm({
		beforeSubmit: checkForm, // 此方法主要是提交前执行的方法，根据需要设置
		success: complete, // 这是提交后的方法
		dataType: 'json'
	});

	function checkForm() {
			var addr = $('input[name=addr]').val();
			
			if($.trim(addr) == ''){
				layer.msg("请选择拍摄地点");return false;
			}

			var title = $('input[name=title]').val();
			
			if($.trim(title) == ''){
				layer.msg("标题不得为空");return false;
			}

			var content = $('textarea[name=content]').val();

			if($.trim(content).length > 500 || $.trim(content).length == 0){
				layer.msg("内容不得为空或超过500字");
				return false;
			}
	
			if(imgNum == 0){
				layer.msg("请上传图片");
				return false;
			}

		

	}

	function complete(data) {
		if (data.code == 1) {
			layer.alert(data.msg, {
				icon: 6
			}, function (index) {
				layer.close(index);
				window.location.href = data.url;
			});

		} else {
			layer.alert(data.msg, {
				icon: 5
			}, function (index) {
				layer.close(index);
				window.location.href = data.url;
			});

		}
	}

</script>
	
	<script type="text/javascript">

		$(function () {
			/**
			 * 通过数组id获取地址列表数组
			 *
			 * @param {Number} id
			 * @return {Array} 
			 */
			function getAddrsArrayById(id) {
				var results = [];
				if (addr_arr[id] != undefined)
					addr_arr[id].forEach(function (subArr) {
						results.push({
							key: subArr[0],
							val: subArr[1]
						});
					});
				else {
					return;
				}
				return results;
			}
			/**
			 * 通过开始的key获取开始时应该选中开始数组中哪个元素
			 *
			 * @param {Array} StartArr
			 * @param {Number|String} key
			 * @return {Number} 
			 */
			function getStartIndexByKeyFromStartArr(startArr, key) {
				var result = 0;
				if (startArr != undefined)
					startArr.forEach(function (obj, index) {
						if (obj.key == key) {
							result = index;
							return false;
						}
					});
				return result;
			}

			//bind the click event for 'input' element
			$("#myAddrs").click(function () {
				var PROVINCES = [],
					startCities = [],
					startDists = [];
				//Province data，shall never change.
				addr_arr[0].forEach(function (prov) {
					PROVINCES.push({
						key: prov[0],
						val: prov[1]
					});
				});
				//init other data.
				var $input = $(this),
					dataKey = $input.attr("data-key"),
					provKey = 1, //default province 北京
					cityKey = 36, //default city 北京
					distKey = 37, //default district 北京东城区
					distStartIndex = 0, //default 0
					cityStartIndex = 0, //default 0
					provStartIndex = 0; //default 0

				if (dataKey != "" && dataKey != undefined) {
					var sArr = dataKey.split("-");
					if (sArr.length == 3) {
						provKey = sArr[0];
						cityKey = sArr[1];
						distKey = sArr[2];

					} else if (sArr.length == 2) { //such as 台湾，香港 and the like.
						provKey = sArr[0];
						cityKey = sArr[1];
					}
					startCities = getAddrsArrayById(provKey);
					startDists = getAddrsArrayById(cityKey);
					provStartIndex = getStartIndexByKeyFromStartArr(PROVINCES, provKey);
					cityStartIndex = getStartIndexByKeyFromStartArr(startCities, cityKey);
					distStartIndex = getStartIndexByKeyFromStartArr(startDists, distKey);
				}
				var navArr = [{ //3 scrollers, and the title and id will be as follows:
					title: "省",
					id: "scs_items_prov"
				}, {
					title: "市",
					id: "scs_items_city"
				}, {
					title: "区",
					id: "scs_items_dist"
				}];
				SCS.init({
					navArr: navArr,
					onOk: function (selectedKey, selectedValue) {
						$input.val(selectedValue).attr("data-key", selectedKey);
					}
				});
				var distScroller = new SCS.scrollCascadeSelect({
					el: "#" + navArr[2].id,
					dataArr: startDists,
					startIndex: distStartIndex
				});
				var cityScroller = new SCS.scrollCascadeSelect({
					el: "#" + navArr[1].id,
					dataArr: startCities,
					startIndex: cityStartIndex,
					onChange: function (selectedItem, selectedIndex) {
						distScroller.render(getAddrsArrayById(selectedItem.key), 0); //re-render distScroller when cityScroller change
					}
				});
				var provScroller = new SCS.scrollCascadeSelect({
					el: "#" + navArr[0].id,
					dataArr: PROVINCES,
					startIndex: provStartIndex,
					onChange: function (selectedItem,
						selectedIndex
					) { //re-render both cityScroller and distScroller when provScroller change
						cityScroller.render(getAddrsArrayById(selectedItem.key), 0);
						distScroller.render(getAddrsArrayById(cityScroller.getSelectedItem().key), 0);
					}
				});
			});
			// 选择城市三级联动止

		});
	</script>


</body>

</html>